# This workflow will build a .NET project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net

name: Publish

on:
  release:
    types: [published]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
      with:
        ref: ${{ github.head_ref }}   # checkout the correct branch name
        fetch-depth: 0
    - name: Git Version
      id: gitversion
      uses: codacy/git-version@2.4.0
      with:
       release-branch: main
       dev-branch: dev
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 6.0.x
    - name: Restore dependencies
      run: dotnet restore
    - name: Semver Parse
      id: semver
      uses: release-kit/semver@v1
      
    - name: prepare version patch
      uses: actions/github-script@v6
      id: my-script
      with:
        result-encoding: string
        retries: 3
        script: |
          echo "<Project>" > ./src/Version.props
          echo "	<PropertyGroup>" >> ./src/Version.props
          echo "    <AssemblyVersion>@@@Major@@@.@@@Minor@@@.@@@Patch@@@</AssemblyVersion>" >> ./src/Version.props
          echo "    <FileVersion>@@@Major@@@.@@@Minor@@@.@@@Patch@@@-@@@SHA@@@</FileVersion>" >> ./src/Version.props
          echo "    <PackageVersion>@@@Major@@@.@@@Minor@@@.@@@Patch@@@@@@PreRelease@@@</PackageVersion>" >> ./src/Version.props
          echo "    <InformationalVersion>@@@Major@@@.@@@Minor@@@.@@@Patch@@@@@@PreRelease@@@-@@@SHA@@@</InformationalVersion>" >> ./src/Version.props
          echo "	</PropertyGroup>" >> ./src/Version.props
          echo "</Project>" >> ./src/Version.props
          
    - name: Replace major-version
      uses: alexrogalskiy/github-action-tag-replacer@master
      with:
        prefix: '@@@'
        suffix: '@@@'
        sourceFile: './src/Version.props'
        placeholder: 'Major'
        replacement: ${{ steps.version.outputs.major }}
        
    - name: Replace major-version
      uses: alexrogalskiy/github-action-tag-replacer@master
      with:
        prefix: '@@@'
        suffix: '@@@'
        sourceFile: './src/Version.props'
        placeholder: 'Minor'
        replacement: ${{ steps.version.outputs.minor }}
        
    - name: Replace patch-version
      uses: alexrogalskiy/github-action-tag-replacer@master
      with:
        prefix: '@@@'
        suffix: '@@@'
        sourceFile: './src/Version.props'
        placeholder: 'Patch'
        replacement: ${{ steps.version.outputs.patch }}
        
    - name: Replace patch-version
      uses: alexrogalskiy/github-action-tag-replacer@master
      with:
        prefix: '@@@'
        suffix: '@@@'
        sourceFile: './src/Version.props'
        placeholder: 'Patch'
        replacement: ${{ steps.version.outputs.patch }}
        
    - name: Replace prerelease-version
      uses: alexrogalskiy/github-action-tag-replacer@master
      with:
        prefix: '@@@'
        suffix: '@@@'
        sourceFile: './src/Version.props'
        placeholder: 'PreRelease'
        replacement: ${{ steps.version.outputs.prerelease  }}
        
    - name: Replace prerelease-version
      uses: alexrogalskiy/github-action-tag-replacer@master
      with:
        prefix: '@@@'
        suffix: '@@@'
        sourceFile: './src/Version.props'
        placeholder: 'SHA'
        replacement: ${{github.sha}}
        
    - name: Build
      run: dotnet build --configuration Release --no-restore
    - name: Test
      run: dotnet test --configuration Release --no-build --verbosity normal
    - name: Pack
      run: dotnet pack --configuration Release --no-build --verbosity normal
    - uses: actions/upload-artifact@v3
      with:
        name: my-artifact
        path: "**/*.nupkg"
